# Tome

Tome is a library written to support relay scripts for KoLMafia written in Typescript with React.

Tome is split in to two parts: The client and the server. The client is a library to be imported in
those relay scripts, whereas the server is a script that runs directly in KoLMafia and exposes data
to the client library.

## Install

### Server

You'll have to manually copy the built server script to your relay server for the time being.
There will be an automatically generated server-release branch soon.

### Client

For the time being you'll have to follow the developer setup instead of simply running `yarn add
tome-kolmafia-client`. That will be hooked up soon&trade;. Afterwards, you'll need to do some
hackery with your build system to get tome-kolmafia-client treated as kolmafia. Afterwards you'll
be able to import functions as if from kolmafia, and even use
[libram](https://github.com/loathers/libram) in the browser!

After that, there's a little more work to be done before you can fully benefit, however. You'll need
to wrap your App on some level (above wherever you want to run kolmafia functions) with a
`RefreshContextProvider`. Then the rest of your app should be in a subcomponent of that context
provider, with `useContext(RefreshContext)`. These two things should be imported from
`tome-kolmafia-client` rather than `kolmafia` unless you want your dev environment to become
confused.

## How to get your build system to treat tome-kolmafia-client as kolmafia

### esbuild

Inside of your build call in your build script, make sure the value of `alias` contains `kolmafia:
'tome-kolmafia-client'`. Example below.

```
build({
    alias: { kolmafia: 'tome-kolmafia-client' },
    ...remainingconfig
})
```

### Webpack

Hopefully someone who knows will fill this section in soon!

## Advanced Usage

The `RefreshContextProvider` that you wrap your app in can have its default refresh conditions
overwritten via `charStateOverride`. This should be provided with a callback that returns a
`Promise<Record<string, unknown>>`. Any time the values in the record change, data will be
refreshed. The default behavior if no `charStateOverride` is provided is to refresh when your turn
count, meat, hp, mp, familiar, or adventure count change.

## Developer Setup

For testing actual development of tome itself, rather than setting up a script to utilize the
client, you'll first have to do the usual `yarn install` + `yarn build` inside the client folder.
From there, run `yarn pack`. You may need to also bump the version slightly to prevent the project
you are importing it to from using a cached version or something weird like that, although I'm not
super sure about that yet. Anyway, copy the .tgz file generated by `yarn pack` over to the project
you would like to test out your tome changes in. From there you'll need to `yarn remove
tome-kolmafia-client` if you already have tome hooked up in that project, and then `yarn add
"file:packedfilenamehere.tgz"`. From there you should be able to use tome normally.
